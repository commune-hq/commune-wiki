<script is:inline>
// === STARRED LINKS INITIALIZATION ===
// Adds ⭐ stars to links pointing to starred notes

(function() {
  let backlinksData = null;

  async function initializeStarredLinks(scope = document) {
    try {
      // Fetch backlinks data if not already loaded
      if (!backlinksData) {
        const res = await fetch('/backlinks.json');
        if (res.ok) {
          backlinksData = await res.json();
        } else {
          console.warn('Failed to load backlinks.json for starred links');
          return;
        }
      }

      // Find all links to /notes/ within the scope, excluding backlinks section
      // (BacklinksScript handles those separately)
      const allNoteLinks = scope.querySelectorAll('a[href^="/notes/"]');
      const noteLinks = Array.from(allNoteLinks).filter(link => !link.closest('.backlinks'));

      noteLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;

        // Normalize href to match backlinks.json format (ensure trailing slash)
        const normalizedHref = href.endsWith('/') ? href : href + '/';
        const note = backlinksData[normalizedHref];

        if (note?.isStarred) {
          // Check if star isn't already there
          if (!link.querySelector('.star-indicator-inline')) {
            // Create star as a separate clickable element (not part of the link)
            const star = document.createElement('span');
            star.className = 'star-indicator-inline';
            star.textContent = ' ⭐';
            star.setAttribute('aria-label', 'Top 5% most referenced - click to learn more');
            star.setAttribute('role', 'button');
            star.setAttribute('tabindex', '0');

            // Click handler to open modal (not navigate)
            star.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (typeof window.showStarModal === 'function') {
                window.showStarModal();
              }
            });

            // Keyboard support
            star.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.stopPropagation();
                if (typeof window.showStarModal === 'function') {
                  window.showStarModal();
                }
              }
            });

            // Insert star after the link
            link.insertAdjacentElement('afterend', star);
          }
        }
      });
    } catch (error) {
      console.error('Error initializing starred links:', error);
    }
  }

  // Make it globally available for dynamic pane loading
  window.initializeStarredLinks = initializeStarredLinks;

  // Auto-initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => initializeStarredLinks());
  } else {
    initializeStarredLinks();
  }
})();
</script>
