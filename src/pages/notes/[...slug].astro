---
/**
 * Dynamic route for Andy-style atomic notes.
 * 
 * Features:
 * - Center column with prose typography
 * - Status badge (seed/growing/evergreen)
 * - Backlinks sidebar
 * - Related notes (by tags)
 * - Updated timestamp
 */

import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Backlinks from '../../components/Backlinks.astro';
import RelatedNotes from '../../components/RelatedNotes.astro';
import '../../styles/notes.css';

export async function getStaticPaths() {
	const notes = await getCollection('notes', ({ data }) => data.visibility === 'public');
	return notes.map((note) => ({
		params: { slug: note.slug },
		props: { note },
	}));
}

interface Props {
	note: CollectionEntry<'notes'>;
}

const { note } = Astro.props;
const { Content } = await note.render();
const { title, status, tags, updated, summary } = note.data;

// Status styling
const statusColors = {
	seed: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
	growing: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
	evergreen: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
};
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{title} - Commune Notes</title>
		<meta name="description" content={summary || title} />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		
		<!-- Open Graph -->
		<meta property="og:title" content={title} />
		<meta property="og:description" content={summary || title} />
		<meta property="og:type" content="article" />
		
		<!-- Styles -->
		<link rel="stylesheet" href="/src/styles/commune.css" />
	</head>
	<body class="bg-[var(--sl-color-bg)] text-[var(--sl-color-text)]">
		<!-- Header -->
		<header class="border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-[var(--sl-color-bg)]/80 backdrop-blur-md z-10">
			<div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
				<a href="/" class="font-bold text-xl text-[var(--sl-color-accent)]">Commune</a>
				<nav class="flex gap-6 text-sm">
					<a href="/" class="hover:text-[var(--sl-color-accent)]">Docs</a>
					<a href="/notes/commune/" class="font-medium hover:text-[var(--sl-color-accent)]">Notes</a>
					<a href="https://github.com/dmthepm/infra-home-server" target="_blank" class="hover:text-[var(--sl-color-accent)]">GitHub</a>
				</nav>
			</div>
		</header>

		<!-- Main Layout: Center prose + Right sidebar -->
		<div class="max-w-7xl mx-auto px-4 py-12 lg:grid lg:grid-cols-[1fr_min(65ch,100%)_1fr] lg:gap-8">
			<!-- Left spacer (empty on mobile, spacing on desktop) -->
			<div class="hidden lg:block"></div>

			<!-- Main content column -->
			<main class="prose prose-lg prose-neutral dark:prose-invert max-w-none">
				<!-- Title + Metadata -->
				<header class="mb-8 not-prose">
					<h1 class="text-4xl font-bold mb-3">{title}</h1>
					<div class="flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
						<!-- Status badge -->
						<span class={`px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[status]}`}>
							{status}
						</span>
						
						<!-- Tags -->
						{tags.map((tag) => (
							<span class="px-2.5 py-0.5 rounded-full text-xs bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
								#{tag}
							</span>
						))}
						
						<!-- Updated date -->
						{updated && (
							<span class="text-xs">
								Updated {updated}
							</span>
						)}
					</div>
				</header>

				<!-- Note content (rendered markdown) -->
				<Content />

				<!-- Footer -->
				<hr class="my-12" />
				<footer class="text-sm text-gray-600 dark:text-gray-400 not-prose">
					<p class="mb-4">
						This is a <strong>working note</strong>. It evolves as I learn and think.
					</p>
					<p>
						<a href="/" class="text-[var(--sl-color-accent)] hover:underline">← Back to Commune</a>
					</p>
				</footer>
			</main>

			<!-- Right sidebar: Backlinks + Related Notes -->
			<aside class="hidden lg:block space-y-8 pt-16">
				<Backlinks slug={note.slug} />
				<RelatedNotes slug={note.slug} tags={tags} />
			</aside>
		</div>

		<!-- Powered by Commune footer -->
		<footer class="border-t border-gray-200 dark:border-gray-800 mt-24 py-8">
			<div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-600 dark:text-gray-400">
				<p>
					Powered by <a href="https://github.com/dmthepm/infra-home-server" target="_blank" class="font-medium text-[var(--sl-color-accent)] hover:underline">Commune</a>
					— Local-first personal AI infrastructure
				</p>
			</div>
		</footer>
	</body>
</html>

