---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Header from '../../components/Header.astro';
import SearchModal from '../../components/SearchModal.astro';
import Backlinks from '../../components/Backlinks.astro';
import PaneStack from '../../components/PaneStack.astro';
import '../../styles/notes.css';

export async function getStaticPaths() {
	const notes = await getCollection('notes', ({ data }) => data.visibility === 'public');
	return notes.map((note) => ({
		params: { slug: note.slug },
		props: { entry: note },
	}));
}

interface Props {
	entry: CollectionEntry<'notes'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { slug, data } = entry;
const title = data.title ?? slug;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title} | Commune</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={data.summary || title} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <Header />
    <SearchModal />
    <main class="note">
      <article class="prose">
        <h1>{title}</h1>
        <Content />
      </article>
      <Backlinks slug={`/notes/${slug}/`} title={title} />
    </main>
    <PaneStack />
    <script type="module">
      // Import and initialize note preview and panes
      import { setupNotePreviews } from '../../components/note-preview.ts';
      import { setupPanes } from '../../components/panes.ts';
      
      setupNotePreviews();
      setupPanes();
    </script>
  </body>
</html>

<style>
  .note{max-width:860px;margin:1.2rem auto;padding:0 1rem 6rem}
  .prose{font-size:1.02rem;line-height:1.7;max-width:65ch}
  .prose a{text-decoration:underline 1px; text-underline-offset:2px}
  .prose h1{font-size:2.2rem;line-height:1.2;margin:.2rem 0 1.2rem}
</style>
