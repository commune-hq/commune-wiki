---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Header from '../../components/Header.astro';
import SearchModal from '../../components/SearchModal.astro';
import Backlinks from '../../components/Backlinks.astro';
import PaneStack from '../../components/PaneStack.astro';

export async function getStaticPaths() {
	const notes = await getCollection('notes', ({ data }) => data.visibility === 'public');
	return notes.map((note) => ({
		params: { slug: note.slug },
		props: { entry: note },
	}));
}

interface Props {
	entry: CollectionEntry<'notes'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { slug, data } = entry;
const title = data.title ?? slug;
---
<html lang="en">
  <head>
    <title>{title} | Commune</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={data.summary || title} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <Header />
    <SearchModal />
    <main class="note">
      <article class="prose">
        <h1>{title}</h1>
        <Content />
      </article>
      <Backlinks slug={`/notes/${slug}/`} title={title} />
    </main>
    <PaneStack />
    <script type="module">
      // Note preview functionality
      const cache = new Map();
      function setupNotePreviews(){
        const show = (el, html, x, y) => {
          let card = document.getElementById('note-hover');
          if(!card){
            card = document.createElement('div');
            card.id = 'note-hover';
            card.style.position = 'fixed';
            card.style.maxWidth = '420px';
            card.style.background = 'var(--sl-color-bg, #fff)';
            card.style.boxShadow = '0 20px 60px rgba(0,0,0,.25)';
            card.style.border = '1px solid rgba(0,0,0,.08)';
            card.style.borderRadius = '10px';
            card.style.padding = '12px 14px';
            card.style.zIndex = '60';
            document.body.appendChild(card);
          }
          card.innerHTML = html;
          card.style.left = Math.min(x+16, window.innerWidth-460) + 'px';
          card.style.top = Math.min(y+16, window.innerHeight-220) + 'px';
          card.hidden = false;
        };
        const hide = () => {
          const card = document.getElementById('note-hover');
          if (card) card.hidden = true;
        };

        document.addEventListener('mouseover', async (e) => {
          const a = e.target?.closest?.('a[href^="/notes/"]');
          if(!a) return;
          const url = a.getAttribute('href');
          if(cache.has(url)){ show(a, cache.get(url), e.clientX, e.clientY); return; }
          try{
            const r = await fetch(url);
            const t = await r.text();
            const doc = new DOMParser().parseFromString(t, 'text/html');
            const main = doc.querySelector('main') ?? doc.body;
            const paras = Array.from(main.querySelectorAll('p')).slice(0,3).map(p => p.outerHTML).join('');
            const html = `<div style="font-weight:600;margin-bottom:.3rem">${doc.title?.replace(/ \|.*/,'')}</div>${paras}`;
            cache.set(url, html);
            show(a, html, e.clientX, e.clientY);
          }catch{}
        });
        document.addEventListener('mouseout', (e) => {
          const a = e.target?.closest?.('a[href^="/notes/"]');
          if(a) setTimeout(() => {
            const card = document.getElementById('note-hover');
            if (card) card.hidden = true;
          }, 120);
        });
      }

      // Pane stack functionality
      function setupPanes(){
        const stack = document.getElementById('pane-stack');
        if(!stack) return;

        async function openPane(url){
          const res = await fetch(url);
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const main = doc.querySelector('main') ?? doc.body;
          const pane = document.createElement('div');
          pane.className = 'pane';
          pane.innerHTML = `<header><strong>${doc.title?.replace(/ \|.*/,'')}</strong>
            <button class="close" aria-label="Close">Ã—</button></header><div class="body">${main.innerHTML}</div>`;
          pane.querySelector('.close').addEventListener('click', () => pane.remove());
          stack.appendChild(pane);
          stack.scrollLeft = stack.scrollWidth;
          // limit
          const panes = stack.querySelectorAll('.pane');
          if(panes.length > 3) panes[0].remove();
        }

        document.addEventListener('click', (e) => {
          const a = e.target?.closest?.('a[href^="/notes/"]');
          if(!a) return;
          if (window.innerWidth < 1024) return; // mobile: let it navigate
          e.preventDefault();
          openPane(a.href);
          history.pushState({ pane: a.href }, '', a.href);
        });

        addEventListener('popstate', (e) => {
          // simple: close a pane on back, ignore forward for now
          const panes = stack.querySelectorAll('.pane');
          if(panes.length) panes[panes.length-1].remove();
        });
      }

      setupNotePreviews();
      setupPanes();
    </script>
  </body>
</html>

<style>
  .note{max-width:860px;margin:1.2rem auto;padding:0 1rem 6rem}
  .prose{font-size:1.02rem;line-height:1.7;max-width:65ch}
  .prose a{text-decoration:underline 1px; text-underline-offset:2px}
  .prose h1{font-size:2.2rem;line-height:1.2;margin:.2rem 0 1.2rem}
</style>